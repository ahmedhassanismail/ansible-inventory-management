pipeline {
    agent any
    
    parameters {
        string(name: 'LOCAL_OPATCH_JAR', defaultValue: '/home/appadmin/OPatch/6880880/opatch_generic.jar', description: 'Path to OPatch JAR file on Ansible server')
        string(name: 'OPATCH_TEMP_DIR', defaultValue: 'E:\\OPatch_source', description: 'Temporary directory on Windows server for OPatch JAR')
        string(name: 'JAVA_PATH', defaultValue: 'E:\\jdk1.8.0_441\\bin\\java.exe', description: 'Java executable path on Windows server')
        string(name: 'ORACLE_HOME', defaultValue: 'E:\\Oracle\\Middleware\\Oracle_Home', description: 'Oracle Home directory path on Windows server')
        choice(name: 'TARGET_HOSTS', choices: ['prod_weblogic_win', 'prod_weblogic_medgo', 'prod_weblogic_batch', 'prod_weblogic_external_reports'], description: 'Target host group from inventory')
        booleanParam(name: 'DRY_RUN', defaultValue: false, description: 'Run in check mode (dry run) - preview changes without making them')
        booleanParam(name: 'VERBOSE', defaultValue: true, description: 'Enable verbose output for detailed logging')
    }
    
    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    // Validate required parameters
                    def requiredParams = [
                        'LOCAL_OPATCH_JAR', 'OPATCH_TEMP_DIR', 'JAVA_PATH', 'ORACLE_HOME'
                    ]
                    
                    requiredParams.each { param ->
                        if (!params[param]?.trim()) {
                            error "Parameter ${param} is required! Please provide a value."
                        }
                    }
                    
                    echo "âœ… All required parameters provided:"
                    requiredParams.each { param ->
                        echo "   ${param}: ${params[param]}"
                    }
                }
            }
        }
        
        stage('Pre-Execution Summary') {
            steps {
                script {
                    echo """
                    ===== PRE-EXECUTION SUMMARY =====
                    ğŸ¯ Target Environment: PROD
                    ğŸ”§ OPatch JAR: ${params.LOCAL_OPATCH_JAR}
                    ğŸ“ Temp Directory: ${params.OPATCH_TEMP_DIR}
                    â˜• Java Path: ${params.JAVA_PATH}
                    ğŸ  Oracle Home: ${params.ORACLE_HOME}
                    ğŸ–¥ï¸  Target Hosts: ${params.TARGET_HOSTS}
                    ğŸ” Dry Run Mode (TEST MODE): ${params.DRY_RUN ? 'ENABLED' : 'DISABLED'}
                    ğŸ“Š Verbose Output: ${params.VERBOSE ? 'ENABLED' : 'DISABLED'}
                    =================================
                    """
                }
            }
        }
        
        stage('Execute OPatch Upgrade') {
            steps {
                script {
                    def checkMode = params.DRY_RUN ? '--check' : ''
                    def verboseFlag = params.VERBOSE ? '-vv' : ''
                    
                    def ansibleCmd = """
                        ansible-playbook -i inventory upgrade_opatch_windows.yml \\
                          -e "local_opatch_jar='${params.LOCAL_OPATCH_JAR}'" \\
                          -e "opatch_temp_dir='${params.OPATCH_TEMP_DIR}'" \\
                          -e "java_path='${params.JAVA_PATH}'" \\
                          -e "oracle_home='${params.ORACLE_HOME}'" \\
                          --limit ${params.TARGET_HOSTS} \\
                          ${checkMode} \\
                          ${verboseFlag}
                    """.stripIndent()
                    
                    echo "ğŸš€ Executing Ansible command:"
                    echo ansibleCmd
                    
                    if (params.DRY_RUN) {
                        echo "âš ï¸  DRY RUN MODE: No actual changes will be made!"
                        echo "ğŸ“‹ This will show what would happen without upgrading OPatch"
                    }
                    
                    sh ansibleCmd
                }
            }
        }
        
        stage('Post-Execution Summary') {
            steps {
                script {
                    def executionStatus = params.DRY_RUN ? "DRY RUN COMPLETED" : "OPATCH UPGRADE COMPLETED"
                    
                    echo """
                    ===== ${executionStatus} =====
                    ğŸ”§ OPatch JAR: ${params.LOCAL_OPATCH_JAR}
                    ğŸ“ Temp Directory: ${params.OPATCH_TEMP_DIR}
                    â˜• Java Path: ${params.JAVA_PATH}
                    ğŸ  Oracle Home: ${params.ORACLE_HOME}
                    ğŸ–¥ï¸  Target Hosts: ${params.TARGET_HOSTS}
                    â° Execution Time: ${new Date().format("yyyy-MM-dd HH:mm:ss")}
                    =========================================
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ OPatch upgrade pipeline completed"
        }
        success {
            if (params.DRY_RUN) {
                echo "âœ… OPatch upgrade dry run completed successfully!"
                echo "ğŸ“‹ Review the output above to see what would happen during OPatch upgrade"
                echo "ğŸ”„ To execute actual upgrade, run the pipeline again with DRY_RUN=false"
            } else {
                echo "âœ… OPatch upgrade completed successfully!"
                echo "ğŸ”§ OPatch has been upgraded using ${params.LOCAL_OPATCH_JAR}"
                echo "ğŸ“¦ OPatch JAR was copied to ${params.OPATCH_TEMP_DIR}"
                echo "â˜• Java at ${params.JAVA_PATH} was used for upgrade"
                echo "ğŸŒ WebLogic OPatch has been updated"
            }
        }
        failure {
            echo "âŒ OPatch upgrade failed!"
            echo "ğŸ” Check the console output above for error details"
            echo "ğŸ“‹ Verify all parameters are correct"
            echo "ğŸ–¥ï¸  Ensure target hosts are accessible"
            echo "ğŸ“¦ Check if OPatch JAR exists at ${params.LOCAL_OPATCH_JAR}"
            echo "â˜• Verify Java path: ${params.JAVA_PATH}"
            echo "ğŸ  Verify Oracle Home path: ${params.ORACLE_HOME}"
        }
    }
}
